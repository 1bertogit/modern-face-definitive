---
/**
 * Dynamic Blog Post Route (PT-BR)
 * Uses Content Collections to render MDX blog posts
 * Enhanced with reading progress, TOC, and share buttons
 */
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Breadcrumb from '@components/ui/Breadcrumb.astro';
import SchemaArticle from '@components/seo/SchemaArticle.astro';
import SchemaFAQ from '@components/seo/SchemaFAQ.astro';
import SchemaPerson from '@components/seo/SchemaPerson.astro';
import ReadingProgress from '@components/blog/ReadingProgress';
import TableOfContents from '@components/blog/TableOfContents';
import ShareButtons from '@components/blog/ShareButtons.astro';
import { getBlogAlternates, getRelatedPosts, getBlogLabels, postToArticle } from '@lib/blog-utils';

// Get canonical URL for share buttons
const canonicalUrl = new URL(
  Astro.url.pathname,
  Astro.site || 'https://facemoderna.com.br'
).toString();

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft && data.locale === 'pt');

  return posts.map((post) => {
    // Remove locale prefix from slug (e.g., "pt/slug" -> "slug")
    const slugParts = post.slug.split('/');
    const slug = slugParts.length > 1 ? slugParts.slice(1).join('/') : post.slug;

    return {
      params: { slug },
      props: { post },
    };
  });
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();
const { data } = post;
const allowedArticleTypes = [
  'Article',
  'MedicalWebPage',
  'TechArticle',
  'ScholarlyArticle',
] as const;
const articleType: (typeof allowedArticleTypes)[number] = allowedArticleTypes.includes(
  data.articleType as (typeof allowedArticleTypes)[number]
)
  ? (data.articleType as (typeof allowedArticleTypes)[number])
  : 'Article';

const locale = 'pt';
const t = getBlogLabels(locale);

// Get alternate language versions for hreflang (translated slugs via canonicalSlug)
const alternates = await getBlogAlternates(data.canonicalSlug);

// Get related posts
const relatedPosts = await getRelatedPosts(post, 3);

const breadcrumbs = [
  { name: t.home, url: '/pt' },
  { name: t.blog, url: '/pt/blog' },
  { name: data.title, url: Astro.url.pathname },
];
---

<BaseLayout
  title={`${data.title} | Dr. Roberio Brandao`}
  description={data.description}
  keywords={data.keywords || []}
  lang={locale}
  customAlternates={alternates}
>
  <SchemaArticle
    title={data.title}
    description={data.description}
    section={data.category}
    keywords={data.keywords || []}
    articleType={articleType}
    datePublished={data.date.toISOString().split('T')[0]}
  />
  {data.faq && <SchemaFAQ items={data.faq} />}
  <SchemaPerson />

  <!-- Reading Progress Bar -->
  <ReadingProgress client:load />

  <!-- Hero -->
  <section class="section-md bg-gradient-to-b from-primary-900 to-primary-800">
    <div class="prose-base">
      <Breadcrumb items={breadcrumbs} class="text-primary-300 mb-8" />

      <div class="flex items-center gap-2 text-accent-400 body-small mb-4">
        <span class="material-symbols-outlined text-lg">menu_book</span>
        <span>{data.category} &bull; {data.readTime || '5 min'} {t.readTime}</span>
      </div>

      <h1 class="heading-1-white mb-6">
        {data.title}
      </h1>

      <p class="body-large-light mb-8">
        {data.description}
      </p>

      <div class="flex flex-wrap items-center gap-x-6 gap-y-2 text-primary-300">
        <div class="flex items-center gap-3">
          <img
            src="/images/blog_roberio_autor.jpg"
            alt={data.author}
            class="w-10 h-10 rounded-full object-cover flex-shrink-0"
            loading="lazy"
          />
          <div>
            <p class="text-white font-medium text-base leading-tight">{data.author}</p>
            <p class="text-primary-400 text-sm leading-tight">{t.creator}</p>
          </div>
        </div>
        <div class="flex items-center gap-2 text-primary-400">
          <span class="w-1 h-1 rounded-full bg-primary-500"></span>
          <span class="text-sm">
            {t.updated}{' '}
            {
              data.date.toLocaleDateString('pt-BR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })
            }
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- Content with Sidebar -->
  <div class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6">
      <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
        <!-- Main Article Content -->
        <article class="flex-1 min-w-0 max-w-4xl">
          <div
            class="prose prose-lg max-w-none prose-headings:font-serif prose-headings:text-primary-900 prose-a:text-accent-600 hover:prose-a:text-accent-700 prose-blockquote:border-accent-500 prose-blockquote:text-primary-800"
          >
            <Content />
          </div>
        </article>

        <!-- Sidebar -->
        <aside class="w-full lg:w-72 flex-shrink-0 space-y-6 lg:sticky lg:top-20 lg:self-start">
          <!-- Table of Contents -->
          <TableOfContents locale="pt" client:load />

          <!-- Share Buttons -->
          <ShareButtons title={data.title} url={canonicalUrl} locale="pt" />

          <!-- Author Card -->
          <div class="bg-white rounded-xl p-5 border border-gray-100">
            <div class="flex items-center gap-4">
              <img
                src="/images/blog_roberio_autor.jpg"
                alt={data.author}
                class="w-14 h-14 rounded-full object-cover flex-shrink-0"
                loading="lazy"
              />
              <div>
                <p class="text-primary-900 font-medium text-base">{data.author}</p>
                <p class="text-primary-400 text-sm">{t.creator}</p>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- FAQ Section -->
  {
    data.faq && data.faq.length > 0 && (
      <section class="section-md bg-ivory">
        <div class="prose-base">
          <h2 class="heading-2 mb-8">{t.faqTitle}</h2>
          <div class="space-y-6">
            {data.faq.map((item) => (
              <div class="border border-gray-200 rounded-xl overflow-hidden">
                <details class="group">
                  <summary class="flex items-center justify-between p-6 cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                    <h3 class="body-base font-medium text-primary-900 pr-4">{item.question}</h3>
                    <span class="material-symbols-outlined text-warmGray group-open:rotate-180 transition-transform flex-shrink-0">
                      expand_more
                    </span>
                  </summary>
                  <div class="p-6 bg-white">
                    <p class="body-base text-warmGray">{item.answer}</p>
                  </div>
                </details>
              </div>
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- CTA -->
  <section class="section-md bg-primary-900">
    <div class="prose-base text-center">
      <h2 class="heading-2-white mb-4">{t.ctaTitle}</h2>
      <p class="body-base-light mb-6">{t.ctaSubtitle}</p>
      <div class="flex flex-col sm:flex-row justify-center gap-4">
        <a
          href="/pt/educacao"
          class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-accent-500 text-white rounded-lg hover:bg-accent-600 transition-colors font-semibold"
        >
          {t.ctaButton}
        </a>
        <a
          href="/pt/contato"
          class="inline-flex items-center justify-center gap-2 px-6 py-3 border border-white/30 text-white rounded-lg hover:bg-white/10 transition-colors"
        >
          {t.ctaContact}
        </a>
      </div>
    </div>
  </section>

  <!-- Related Articles -->
  {
    relatedPosts.length > 0 && (
      <section class="section-md bg-ivory">
        <div class="prose-base">
          <h2 class="heading-2 mb-8">{t.related}</h2>
          <div class="grid md:grid-cols-2 gap-6">
            {relatedPosts.map((related) => {
              const article = postToArticle(related);
              return (
                <a
                  href={`/pt/blog/${article.slug}`}
                  class="group block p-6 bg-white rounded-xl hover:shadow-lg transition-all"
                >
                  <p class="label-eyebrow mb-2">{article.category}</p>
                  <h3 class="heading-4 group-hover:text-accent-600 mb-2">{article.title}</h3>
                  <p class="body-small line-clamp-2">{article.description}</p>
                </a>
              );
            })}
          </div>
        </div>
      </section>
    )
  }
</BaseLayout>
