---
/**
 * BlogPostLayout.astro
 * Layout completo para artigos individuais do blog
 * Typography otimizada para leitura (max-width: 720px)
 */

import BaseLayout from '@layouts/BaseLayout.astro';
import Breadcrumb from '@components/ui/Breadcrumb.astro';
import SchemaArticle from '@components/seo/SchemaArticle.astro';
import SchemaFAQ from '@components/seo/SchemaFAQ.astro';
import BlogCard from './BlogCard.astro';

export interface Author {
  name: string;
  role: string;
  image?: string;
  bio?: string;
}

export interface RelatedPost {
  slug: string;
  title: string;
  description: string;
  category: string;
  readTime: string;
  date: string;
}

export interface FAQItem {
  question: string;
  answer: string;
}

export interface Props {
  title: string;
  description: string;
  category: string;
  readTime: string;
  date: string;
  author?: Author;
  image?: string;
  keywords?: string[];
  relatedPosts?: RelatedPost[];
  faqItems?: FAQItem[];
  locale?: 'pt' | 'en' | 'es';
  slug: string;
}

const {
  title,
  description,
  category,
  readTime,
  date,
  author = {
    name: 'Dr. Robério Brandão',
    role: 'Cirurgião Facial',
    image: '/images/dr-roberio-avatar.webp',
    bio: 'Especialista em cirurgia facial com mais de 1.500 procedimentos realizados. Criador da técnica Face Moderna® e mentor de cirurgiões em toda América Latina.',
  },
  image,
  keywords = [],
  relatedPosts = [],
  faqItems = [],
  locale = 'pt',
  slug,
} = Astro.props;

// Traduções
const t = {
  pt: {
    home: 'Início',
    blog: 'Blog',
    related: 'Artigos Relacionados',
    readMore: 'Continuar Lendo',
    shareTitle: 'Compartilhar',
    ctaTitle: 'Aprenda com Dr. Robério',
    ctaDescription:
      'Mentoria especializada em cirurgia facial. Domine técnicas avançadas em 30 casos.',
    ctaButton: 'Conhecer Mentoria',
    ctaLink: '/educacao',
  },
  en: {
    home: 'Home',
    blog: 'Blog',
    related: 'Related Articles',
    readMore: 'Continue Reading',
    shareTitle: 'Share',
    ctaTitle: 'Learn with Dr. Robério',
    ctaDescription:
      'Specialized mentorship in facial surgery. Master advanced techniques in 30 cases.',
    ctaButton: 'Explore Mentorship',
    ctaLink: '/education',
  },
  es: {
    home: 'Inicio',
    blog: 'Blog',
    related: 'Artículos Relacionados',
    readMore: 'Seguir Leyendo',
    shareTitle: 'Compartir',
    ctaTitle: 'Aprende con Dr. Robério',
    ctaDescription:
      'Mentoría especializada en cirugía facial. Domina técnicas avanzadas en 30 casos.',
    ctaButton: 'Conocer Mentoría',
    ctaLink: '/es/educacion',
  },
};

const trans = t[locale] || t['pt'];

// URLs
const homeUrl = locale === 'pt' ? '/pt' : locale === 'en' ? '/' : `/${locale}`;
const blogUrl = locale === 'pt' ? '/pt/blog' : locale === 'en' ? '/blog' : `/${locale}/blog`;
const articleUrl =
  locale === 'pt'
    ? `/pt/blog/${slug}`
    : locale === 'en'
      ? `/blog/${slug}`
      : `/${locale}/blog/${slug}`;

// Breadcrumbs
const breadcrumbs = [
  { name: trans.home, url: homeUrl },
  { name: trans.blog, url: blogUrl },
  { name: title, url: articleUrl },
];

// Formatar data
const formatDate = (dateStr: string) => {
  const dateObj = new Date(dateStr);
  const options: Intl.DateTimeFormatOptions = {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  };
  const localeMap = {
    pt: 'pt-BR',
    en: 'en-US',
    es: 'es-ES',
  };
  return dateObj.toLocaleDateString(localeMap[locale] || 'pt-BR', options);
};

const formattedDate = formatDate(date);

// Lang para HTML
const langMap = {
  pt: 'pt-BR',
  en: 'en',
  es: 'es',
} as const;

const htmlLang = (langMap[locale] || 'pt-BR') as 'pt' | 'en' | 'es';
---

<BaseLayout
  title={`${title} | Dr. Robério Brandão`}
  description={description}
  keywords={keywords}
  lang={htmlLang}
>
  <!-- Schema Markup -->
  <SchemaArticle
    title={title}
    description={description}
    section={category}
    keywords={keywords}
    datePublished={date}
  />
  {faqItems.length > 0 && <SchemaFAQ items={faqItems} />}

  <!-- Hero Section -->
  <header class="bg-white section-xs">
    <div class="prose-narrow">
      <!-- Breadcrumb -->
      <div class="mb-8">
        <Breadcrumb items={breadcrumbs} />
      </div>

      <!-- Meta Row -->
      <div class="flex items-center gap-3 mb-6">
        <span class="label-eyebrow bg-accent-50 px-3 py-1.5 rounded-full">
          {category}
        </span>
        <span class="body-small text-softGray flex items-center gap-1">
          <span class="material-symbols-outlined text-base" aria-hidden="true">schedule</span>
          {readTime}
        </span>
      </div>

      <!-- Title -->
      <h1 class="heading-1 mb-6">
        {title}
      </h1>

      <!-- Lead -->
      <p class="body-large mb-8">
        {description}
      </p>

      <!-- Author Row -->
      <div class="flex items-center gap-4 pt-8 border-t border-gray-100">
        <img
          src={author.image || '/images/dr-roberio-avatar.webp'}
          alt={author.name}
          class="w-12 h-12 rounded-full object-cover"
          loading="lazy"
        />
        <div class="flex-1">
          <span class="block text-primary-900 font-medium">{author.name}</span>
          <span class="block body-small text-softGray">{author.role}</span>
        </div>
        <time datetime={date} class="body-small text-softGray">
          {formattedDate}
        </time>
      </div>
    </div>
  </header>

  <!-- Featured Image -->
  {
    image && (
      <figure class="max-w-5xl mx-auto px-4 mb-12">
        <picture>
          <source srcset={image.replace(/\.png$/, '.webp')} type="image/webp" />
          <img
            src={image}
            alt={title}
            class="w-full aspect-[21/9] object-cover rounded-xl"
            loading="lazy"
          />
        </picture>
      </figure>
    )
  }

  <!-- Article Content -->
  <article class="prose-narrow section-md">
    <div class="prose prose-lg max-w-none prose-primary">
      <slot />
    </div>
  </article>

  <!-- Author Box -->
  <aside class="prose-narrow section-md">
    <div class="bg-ivory rounded-2xl p-6 md:p-8 flex flex-col md:flex-row gap-6 items-start">
      <img
        src={author.image || '/images/dr-roberio-avatar.webp'}
        alt={author.name}
        class="w-20 h-20 rounded-full object-cover flex-shrink-0"
        loading="lazy"
      />
      <div class="flex-1">
        <span class="block heading-3 mb-1">{author.name}</span>
        <span class="block text-accent-700 body-small mb-3">{author.role}</span>
        <p class="body-small">
          {author.bio}
        </p>
      </div>
    </div>
  </aside>

  <!-- Related Posts -->
  {
    relatedPosts.length > 0 && (
      <section class="section-md bg-ivory">
        <div class="prose-wide">
          <h2 class="heading-2 mb-8">{trans.related}</h2>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
            {relatedPosts.slice(0, 3).map((post) => (
              <BlogCard {...post} locale={locale} />
            ))}
          </div>
        </div>
      </section>
    )
  }

  <!-- CTA Section -->
  <section class="section-md bg-primary-900">
    <div class="prose-narrow text-center">
      <h2 class="heading-2-white mb-4">
        {trans.ctaTitle}
      </h2>
      <p class="body-large-light mb-8 max-w-xl mx-auto">
        {trans.ctaDescription}
      </p>
      <a
        href={trans.ctaLink}
        class="inline-flex items-center gap-2 px-8 py-4
               bg-accent-600 text-white rounded-lg
               text-sm font-medium uppercase tracking-wider
               hover:bg-accent-500 hover:-translate-y-0.5
               transition-all duration-300
               focus:outline-none focus:ring-2 focus:ring-accent-400 focus:ring-offset-2 focus:ring-offset-primary-900"
      >
        {trans.ctaButton}
        <span class="material-symbols-outlined" aria-hidden="true">arrow_forward</span>
      </a>
    </div>
  </section>
</BaseLayout>

<style is:global>
  /* Typography customizations para artigos */
  .prose-primary {
    --tw-prose-body: #4a4a48;
    --tw-prose-headings: #1e293b;
    --tw-prose-links: #b8956c;
    --tw-prose-bold: #1e293b;
    --tw-prose-quotes: #1e293b;
    --tw-prose-quote-borders: #b8956c;
    --tw-prose-bullets: #b8956c;
    --tw-prose-counters: #b8956c;
  }

  .prose h2 {
    font-family: 'Playfair Display', Georgia, serif;
    font-weight: 400;
    margin-top: 3rem;
    margin-bottom: 1rem;
    scroll-margin-top: 7rem;
  }

  .prose h3 {
    font-family: 'Playfair Display', Georgia, serif;
    font-weight: 400;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    scroll-margin-top: 7rem;
  }

  .prose > p:first-of-type::first-letter {
    float: left;
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 4rem;
    line-height: 0.8;
    margin-right: 0.5rem;
    margin-top: 0.1rem;
    color: #b8956c;
  }

  .prose blockquote {
    border-left-color: #b8956c;
    font-style: italic;
    background: #fafaf8;
    padding: 1.5rem;
    border-radius: 0 0.75rem 0.75rem 0;
  }

  .prose a {
    text-decoration: none;
    border-bottom: 1px solid #b8956c;
    transition:
      border-color 0.3s,
      color 0.3s;
  }

  .prose a:hover {
    color: #9d7f5c;
    border-bottom-color: #9d7f5c;
  }

  .prose img {
    border-radius: 0.75rem;
  }

  .prose figcaption {
    text-align: center;
    font-size: 0.875rem;
    color: #8a8a88;
    margin-top: 0.75rem;
  }

  /* Tabelas estilizadas */
  .prose table {
    font-size: 0.875rem;
  }

  .prose thead th {
    background: #fafaf8;
    font-weight: 600;
  }

  .prose tbody tr:nth-child(even) {
    background: #fafaf8;
  }

  /* Listas com checkmarks */
  .prose ul.checklist {
    list-style: none;
    padding-left: 0;
  }

  .prose ul.checklist li::before {
    content: '✓';
    color: #b8956c;
    font-weight: bold;
    margin-right: 0.5rem;
  }
</style>
