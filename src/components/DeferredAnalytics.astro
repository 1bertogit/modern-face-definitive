---
/**
 * Deferred Analytics Loader
 *
 * Loads non-critical analytics scripts only after first user interaction
 * (scroll or click). This improves initial page load performance and enables
 * bfcache (back/forward cache) compatibility.
 *
 * Benefits:
 * - Faster initial page load (~700ms+ savings)
 * - Better Core Web Vitals scores
 * - bfcache enabled (faster back/forward navigation)
 * - Analytics still track all interactions after load
 *
 * Analytics loaded:
 * - Google Tag Manager (GTM)
 * - PostHog
 * - Google Analytics 4 (GA4)
 *
 * Strategy:
 * - Listen for first scroll OR click event
 * - Load analytics scripts dynamically
 * - Remove event listeners after first load
 * - Use pagehide (not unload) for bfcache compatibility
 */

const gtmId = import.meta.env.PUBLIC_GTM_ID || 'GTM-WHB72B64';
const gaId = import.meta.env.PUBLIC_GA_ID;
const posthogKey = 'phc_Rcc07fdHdGnnkdEvVXeNBKi5vYbUnhX5UypgkTOhChE';
const posthogHost = 'https://us.i.posthog.com';

const isGtmConfigured = gtmId && !gtmId.includes('XXXX');
const isGaConfigured = gaId && gaId !== 'G-XXXXXXXXXX' && !gaId.includes('XXXX');
// PostHog is always loaded (has hardcoded key)
const shouldLoadAnalytics = isGtmConfigured || isGaConfigured || true; // Always true for PostHog
---

{
  shouldLoadAnalytics && (
    <script
      is:inline
      define:vars={{
        gtmId: isGtmConfigured ? gtmId : '',
        gaId: isGaConfigured ? gaId : '',
        posthogKey,
        posthogHost,
        isDev: import.meta.env.DEV,
      }}
      set:html={`
(function() {
  'use strict';
  let analyticsLoaded = false;
  function loadAnalytics() {
    if (analyticsLoaded) return;
    analyticsLoaded = true;
    document.removeEventListener('scroll', loadAnalytics, { passive: true });
    document.removeEventListener('click', loadAnalytics);
    document.removeEventListener('touchstart', loadAnalytics, { passive: true });
    if (typeof window !== 'undefined' && gtmId) {
      if (!document.querySelector('script[src*="googletagmanager.com/gtm.js"]')) {
        window.dataLayer = window.dataLayer || [];
        (function(w,d,s,l,i){
          w[l]=w[l]||[];
          w[l].push({'gtm.start': new Date().getTime(), event:'gtm.js'});
          var f=d.getElementsByTagName(s)[0],
              j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
          j.async=true;
          j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
          f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer',gtmId);
      }
    }
    if (typeof window !== 'undefined' && posthogKey && !window.posthog) {
      !(function(t,e){
        var o,n,p,r;
        e.__SV||((window.posthog=e),(e._i=[]),(e.init=function(i,s,a){
          function g(t,e){
            var o=e.split('.');
            2==o.length&&((t=t[o[0]]),(e=o[1])),(t[e]=function(){
              t.push([e].concat(Array.prototype.slice.call(arguments,0)));
            });
          }
          ((p=t.createElement('script')).type='text/javascript'),
          (p.crossOrigin='anonymous'),
          (p.async=true),
          (p.src=s.api_host+'/static/array.js'),
          (r=t.getElementsByTagName('script')[0]).parentNode.insertBefore(p,r);
          var u=e;
          void 0!==a?(u=e[a]=[]):(a='posthog');
          u.people=u.people||[];
          u.toString=function(t){
            var e='posthog';
            return 'posthog'!==a&&(e+='.'+a),t||(e+=' (stub)'),e;
          };
          u.people.toString=function(){
            return u.toString(1)+'.people (stub)';
          };
          o='capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getNextSurveyStep onSessionId'.split(' ');
          for(n=0;n<o.length;n++)g(u,o[n]);
          e._i.push([i,s,a]);
        }),(e.__SV=1));
      })(document,window.posthog||[]);
      posthog.init(posthogKey, {
        api_host: posthogHost,
        defaults: '2025-05-24'
      });
    }
    if (typeof window !== 'undefined' && gaId) {
      const gtagScript = document.createElement('script');
      gtagScript.async = true;
      gtagScript.src = 'https://www.googletagmanager.com/gtag/js?id=' + gaId;
      document.head.appendChild(gtagScript);
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', gaId, {
        anonymize_ip: true,
        send_page_view: true,
        cookie_flags: 'SameSite=None;Secure'
      });
    }
    // Only log in development (localhost or dev mode)
    if (typeof window !== 'undefined' && (window.location.hostname === 'localhost' || isDev)) {
      console.log('[DeferredAnalytics] Analytics loaded after user interaction');
    }
  }
  document.addEventListener('scroll', loadAnalytics, { passive: true, once: true });
  document.addEventListener('click', loadAnalytics, { once: true });
  document.addEventListener('touchstart', loadAnalytics, { passive: true, once: true });
  setTimeout(function() {
    if (!analyticsLoaded) {
      loadAnalytics();
    }
  }, 3000);
  window.addEventListener('pagehide', function() {});
})();
    `}
    />
  )
}
